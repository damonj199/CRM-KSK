@page "/schedule"
@using System.Globalization
@inject ClientServiceBlazor _clientService
@inject TrainerServiceBlazor _trainerService
@inject ScheduleServiceBlazor _scheduleService
@inject NavigationManager Navigation

<h3>Расписание тренировок</h3>
<a href="/history" @onclick="() => ShowHistory()"> История тренировок</a>

<div class="table-conrainer">
    <table class="schedule-table">
        <thead>
            <tr>
                <th>Время</th>
                @foreach (var day in DaysOfWeekWithDates)
                {
                    <th>@day</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var time in TimeSlots)
            {
                <tr>
                    <td>@time</td>
                    @foreach (var day in DaysOfWeekWithDates)
                    {
                        <td class="schedule-cell @(string.IsNullOrWhiteSpace(GetCellContent(day, time)) ? "empty-cell" : "")"
                        @onclick="() => OpenModal(day, time)">
                            @if(ScheduleData.TryGetValue((day, time), out var contents))
                            {
                                @foreach(var content in contents)
                                {
                                    <div>@content</div>
                                }
                            }
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@if (IsModalOpen)
{
    <div class="modal">
        <div class="modal-content">
            <h4>Добавить тренировку</h4>

            <label>Тренер:</label>
            <select @bind="SelectedTrainerId">
                <option value="">Выберите тренера</option>

                @foreach (var trainer in Trainers)
                {
                    <option value="@trainer.Id">@trainer.FirstName @trainer.LastName</option>
                }
            </select>

            <label>Клиенты:</label>
            <select multiple @bind="SelectedClientId">
                <option value="">Выберите клиента</option>
                @foreach (var client in Clients)
                {
                    <option value="@client.Id">@client.FirstName @client.LastName</option>
                }
            </select>
            <label>Тип тренировки:</label>
            <select @bind="SelectedTrainingType">
                @foreach (var type in Enum.GetValues(typeof(TypeTrainings)))
                {
                    <option value="@type">@((type as Enum).GetDisplayName())</option>
                }
            </select>
            <div class="from-actions mt-2">
                <button class="btn btn-primary" @onclick="SaveTraining">Сохранить</button>
                <button @onclick="CloseModal">Отмена</button>
            </div>
            <div class="from-actions">
                <button class="btn btn-danger mt-2" @onclick="() => DeleteTraining(SelectedTrainingId.Value)">Отменить тренировку</button>
            </div>
        </div>
    </div>
}

@if (ShowTrainingsModal)
{
    <div class="modal">
        <div class="modal-content">
            <h3>Тренировки на @SelectedDay в @SelectedTime</h3>

            @if (SelectedTrainings.Count > 0)
            {
                @foreach (var training in SelectedTrainings)
                {
                    <div class="training-item">
                        <span>@training</span>
                    </div>
                }
            }
            else
            {
                <p>Нет тренировок</p>
            }

            <button class="btn btn-dark" @onclick="OpenAddTrainingModal">Добавить тренировку</button>
            <button class="btn btn-secondary mt-1" @onclick="CloseModal">Закрыть</button>
        </div>
    </div>
}

<style>
    .table-container {
    width: 100vw;
    overflow-x: auto;
    }

    .schedule-table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    }

    .schedule-table th, .schedule-table td {

    min-width: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 5px;
    white-space: nowrap;
    }

    .schedule-table th {
    background-color: #f4f4f4;
    }

    .schedule-cell {
    cursor: pointer;
    height: 50px;
    }

    .schedule-cell:hover {
    background-color: #eef;
    }

    .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    }

    .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    min-width: 300px;
    }

    .training-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    }

    .btn-delete {
    background: red;
    color: white;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 4px;
    }

    .modal-buttons {
    margin-top: 15px;
    }

    .modal-buttons button {
    margin: 5px;
    padding: 5px 10px;
    }

    .empty-cell {
    height: 20px;
    background-color: #f9f9f9;
    }
</style>

@code {
    private readonly List<string> TimeSlots = GenerateTimeSlots("09:00", "22:00");
    private List<string> DaysOfWeekWithDates = new();
    private Dictionary<(string Day, string Time), List<string>> ScheduleData = [];

    private List<TrainerDto> Trainers = [];
    private IReadOnlyList<ClientDto> Clients = [];
    private IReadOnlyList<ScheduleDto> Schedules = [];

    private Guid? SelectedTrainerId;
    private string[] SelectedClientId = [];
    private Guid? SelectedTrainingId;
    private TypeTrainings SelectedTrainingType = TypeTrainings.Unknown;

    private string SelectedDay = string.Empty;
    private string SelectedTime = string.Empty;
    private List<string> SelectedTrainings = [];

    private bool ShowTrainingsModal = false;
    private bool IsModalOpen = false;

    protected override async Task OnInitializedAsync()
    {
        GenerateDaysOfWeekWithDates();
        await LoadDataFromApi();
        await LoadScheduleFromApi();
        EnsureScheduleDataInitialized();
    }

    private void ShowHistory()
    {
        Navigation.NavigateTo("/history");
    }

    private void GenerateDaysOfWeekWithDates()
    {
        var today = DateTime.Today;
        DaysOfWeekWithDates = Enumerable.Range(0, 7)
            .Select(i => today.AddDays(i).ToString("dddd, dd MMMM"))
            .ToList();
    }

    private async Task LoadDataFromApi()
    {
        Trainers = await _trainerService.GetAllTrainers() ?? [];
        Clients = await _clientService.GetClientsByNameAsync() ?? [];
    }

    private async Task LoadScheduleFromApi()
    {
        Schedules = await _scheduleService.GetWeeksSchedule();
        ScheduleData.Clear();
        LoadUI();
    }

    private void LoadUI()
    {
        foreach (var schedule in Schedules)
        {
            var dayKey = schedule.Date.ToString("dddd, dd MMMM", new CultureInfo("ru-RU"));
            var timeKey = schedule.Time.ToString(@"hh\:mm");

            var trainerFullName = $"{schedule.Trainer.LastName} {schedule.Trainer.FirstName}";
            var clientFullName = string.Join(", ", schedule.Clients.Select(c => $"{c.LastName} {c.FirstName}"));

            var trainingInfo = $"{trainerFullName} - {clientFullName} ({schedule.TypeTrainings.GetDisplayName()})";

            if(!ScheduleData.ContainsKey((dayKey, timeKey)))
            {
                ScheduleData[(dayKey, timeKey)] = [];
            }

            ScheduleData[(dayKey, timeKey)].Add(trainingInfo);
        }
    }

    private void EnsureScheduleDataInitialized()
    {
        foreach (var day in DaysOfWeekWithDates)
        {
            foreach (var time in TimeSlots)
            {
                if (!ScheduleData.ContainsKey((day, time)))
                {
                    ScheduleData[(day, time)] = [];
                }
            }
        }
    }

    private static List<string> GenerateTimeSlots(string start, string end)
    {
        var timeSlots = new List<string>();
        var startTime = DateTime.ParseExact(start, "HH:mm", CultureInfo.InvariantCulture);
        var endTime = DateTime.ParseExact(end, "HH:mm", CultureInfo.InvariantCulture);

        while (startTime < endTime)
        {
            timeSlots.Add(startTime.ToString("HH:mm"));
            startTime = startTime.AddMinutes(30);
        }

        return timeSlots;
    }

    private void OpenModal(string day, string time)
    {
        SelectedDay = day;
        SelectedTime = time;

        if (ScheduleData.TryGetValue((day, time), out var trainings) && trainings?.Any() == true)
        {
            SelectedTrainings = new List<string>(trainings);
            ShowTrainingsModal = true;
        }
        else
        {
            IsModalOpen = true;
        }
    }

    private void OpenAddTrainingModal()
    {
        ShowTrainingsModal = false;
        IsModalOpen = true;
    }

    private void CloseModal()
    {
        IsModalOpen = false;
        ShowTrainingsModal = false;
        SelectedTrainerId = null;
        SelectedClientId = [];
    }

    private async Task SaveTraining()
    {
        if (SelectedTrainerId != null && SelectedClientId.Length > 0)
        {
            var trainerDto = Trainers.FirstOrDefault(t => t.Id == SelectedTrainerId.Value);

            var selectedClientGuid = SelectedClientId.Select(id => Guid.Parse(id)).ToList();
            var clientDtos = Clients.Where(c => selectedClientGuid.Contains(c.Id)).ToList();

            var training = new ScheduleDto
                {
                    Id = Guid.NewGuid(),
                    Date = DateOnly.Parse(SelectedDay, new CultureInfo("ru-RU")),
                    Time = TimeSpan.Parse(SelectedTime),
                    Trainer = new ScheduleMemberDto
                    {
                        Id = trainerDto.Id,
                        FirstName = trainerDto.FirstName,
                        LastName = trainerDto.LastName
                    },
                    Clients = clientDtos.Select(c => new ScheduleMemberDto
                    {
                        Id = c.Id,
                        FirstName = c.FirstName,
                        LastName = c.LastName
                    }).ToList(),
                    TypeTrainings = SelectedTrainingType
                };

            await _scheduleService.AddOrUpdateSchedule(training);
            await LoadScheduleFromApi();
            EnsureScheduleDataInitialized();
        }

        CloseModal();
    }

    private string GetCellContent(string day, string time)
    {
        return ScheduleData.TryGetValue((day, time), out var content)
        ? string.Join("<br>", content) : " ";
    }

    private async Task DeleteTraining(Guid id)
    {
        if (id == Guid.Empty)
            return;

        var trainingToRemove = Schedules.FirstOrDefault(t => t.Id == id);

        if(trainingToRemove != null)
        {
            Schedules = Schedules.Where(t => t.Id != id).ToList();
            UpdateScheduleData();
        }
        await _scheduleService.DeleteTrainingAsync(id);
        await LoadDataFromApi();
        EnsureScheduleDataInitialized();

        CloseModal();
    }

    private void UpdateScheduleData()
    {
        ScheduleData.Clear();
        LoadUI();
    }
}
